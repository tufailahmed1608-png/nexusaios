# azure-pipelines/ci.yml
# Continuous Integration Pipeline for Nexus OS
# Runs on all PRs and pushes to main/develop branches

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - '*.md'
      - 'docs/**'
      - 'public/docs/**'

pr:
  branches:
    include:
      - main
      - develop

pool:
  name: 'azurepipeline'

variables:
  nodeVersion: '20.x'

stages:
  - stage: CI
    displayName: 'Build & Validate'
    jobs:
      - job: Lint
        displayName: 'Lint & Format'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(Build.SourcesDirectory)/node_modules
            displayName: 'Cache node_modules'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm run lint
            displayName: 'Run ESLint'

      - job: TypeCheck
        displayName: 'Type Check'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(Build.SourcesDirectory)/node_modules
            displayName: 'Cache node_modules'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npx tsc --noEmit
            displayName: 'TypeScript check'

      - job: SecurityScan
        displayName: 'Security Scan'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm audit --audit-level=high || true
            displayName: 'npm audit'
            continueOnError: true

      - job: Build
        displayName: 'Build Application'
        dependsOn:
          - Lint
          - TypeCheck
        condition: succeeded()
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(Build.SourcesDirectory)/node_modules
            displayName: 'Cache node_modules'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm run build
            displayName: 'Build'
            env:
              VITE_SUPABASE_URL: $(VITE_SUPABASE_URL)
              VITE_SUPABASE_PUBLISHABLE_KEY: $(VITE_SUPABASE_PUBLISHABLE_KEY)

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: 'dist'
              artifactName: 'webapp-$(Build.BuildId)'
            displayName: 'Publish build artifacts'
