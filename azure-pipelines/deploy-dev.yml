# azure-pipelines/deploy-dev.yml
# Development Environment Deployment Pipeline

trigger:
  branches:
    include:
      - develop

pool:
  name: 'azurepipeline'

variables:
  - group: nexus-dev-secrets
  - name: nodeVersion
    value: '20.x'
  - name: environment
    value: 'dev'
  - name: azureRegion
    value: 'swedencentral'

stages:
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: Build
        displayName: 'Build'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(Build.SourcesDirectory)/node_modules
            displayName: 'Cache node_modules'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm run build
            displayName: 'Build application'
            env:
              VITE_SUPABASE_URL: $(VITE_SUPABASE_URL)
              VITE_SUPABASE_PUBLISHABLE_KEY: $(VITE_SUPABASE_PUBLISHABLE_KEY)

          - publish: dist
            artifact: webapp
            displayName: 'Publish webapp artifact'

  - stage: Deploy_Infrastructure
    displayName: 'Deploy Infrastructure'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployBicep
        displayName: 'Deploy Bicep Templates'
        steps:
          - script: |
              echo "Installing Azure CLI..."
              curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
              az --version
            displayName: 'Install Azure CLI'

          - task: AzureCLI@2
            inputs:
              azureSubscription: 'azure-subscription-dev'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Deploying infrastructure to $(environment)..."
                az deployment sub create \
                  --location $(azureRegion) \
                  --template-file infrastructure/azure/main.bicep \
                  --parameters infrastructure/azure/parameters/dev.bicepparam \
                  --parameters postgresAdminLogin="$(DB_USER)" \
                  --parameters postgresAdminPassword="$(DB_PASSWORD)" \
                  --name "nexus-$(environment)-$(Build.BuildId)"
            displayName: 'Deploy Bicep'

  - stage: Deploy_Database
    displayName: 'Run Database Migrations'
    dependsOn: Deploy_Infrastructure
    condition: succeeded()
    jobs:
      - job: Migrate
        displayName: 'Run Migrations'
        steps:
          - script: |
              echo "Installing Azure CLI..."
              curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
            displayName: 'Install Azure CLI'

          - script: |
              sudo apt-get update
              sudo apt-get install -y postgresql-client
            displayName: 'Install PostgreSQL client'

          - task: AzureCLI@2
            inputs:
              azureSubscription: 'azure-subscription-dev'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Running database migrations..."
                for migration in infrastructure/azure/database/migrations/*.sql; do
                  if [ -f "$migration" ]; then
                    echo "Executing: $migration"
                    PGPASSWORD="$(DB_PASSWORD)" psql \
                      -h "$(DB_HOST)" \
                      -U "$(DB_USER)" \
                      -d nexus_$(environment) \
                      -f "$migration" \
                      --single-transaction
                  fi
                done
                echo "Migrations completed."
            displayName: 'Execute migrations'

  - stage: Deploy_Frontend
    displayName: 'Deploy Frontend'
    dependsOn: Deploy_Database
    condition: succeeded()
    jobs:
      - job: DeploySWA
        displayName: 'Deploy to Static Web App'
        steps:
          - download: current
            artifact: webapp
            displayName: 'Download webapp artifact'

          - script: |
              echo "Installing Azure CLI..."
              curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
              echo "Installing SWA CLI..."
              npm install -g @azure/static-web-apps-cli
            displayName: 'Install Azure CLI and SWA CLI'

          - task: AzureCLI@2
            inputs:
              azureSubscription: 'azure-subscription-dev'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Getting Static Web App deployment token..."
                SWA_NAME=$(az staticwebapp list \
                  --resource-group "rg-nexus-os-$(environment)" \
                  --query "[0].name" -o tsv)
                
                if [ -z "$SWA_NAME" ]; then
                  echo "##[error]No Static Web App found in rg-nexus-os-$(environment)"
                  exit 1
                fi
                
                echo "Found Static Web App: $SWA_NAME"
                
                DEPLOYMENT_TOKEN=$(az staticwebapp secrets list \
                  --name "$SWA_NAME" \
                  --resource-group "rg-nexus-os-$(environment)" \
                  --query "properties.apiKey" -o tsv)
                
                echo "Deploying to Azure Static Web App..."
                swa deploy "$(Pipeline.Workspace)/webapp" \
                  --deployment-token "$DEPLOYMENT_TOKEN" \
                  --env production
            displayName: 'Deploy to Azure Static Web Apps'

  - stage: Deploy_Functions
    displayName: 'Deploy Azure Functions'
    dependsOn: Deploy_Database
    condition: succeeded()
    jobs:
      - job: DeployFunctions
        displayName: 'Deploy Functions'
        steps:
          - script: |
              echo "Installing Azure CLI..."
              curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
            displayName: 'Install Azure CLI'

          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - task: AzureCLI@2
            inputs:
              azureSubscription: 'azure-subscription-dev'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Getting Function App name from resource group..."
                FUNC_APP_NAME=$(az functionapp list \
                  --resource-group "rg-nexus-os-$(environment)" \
                  --query "[0].name" -o tsv)
                
                if [ -z "$FUNC_APP_NAME" ]; then
                  echo "##[error]No Function App found in rg-nexus-os-$(environment)"
                  exit 1
                fi
                
                echo "Deploying to Function App: $FUNC_APP_NAME"
                
                # Create deployment package
                cd $(System.DefaultWorkingDirectory)/supabase/functions
                zip -r ../../functions.zip .
                cd ../..
                
                az functionapp deployment source config-zip \
                  --name "$FUNC_APP_NAME" \
                  --resource-group "rg-nexus-os-$(environment)" \
                  --src functions.zip
            displayName: 'Deploy Azure Functions'

  - stage: Smoke_Tests
    displayName: 'Smoke Tests'
    dependsOn:
      - Deploy_Frontend
      - Deploy_Functions
    condition: succeeded()
    jobs:
      - job: HealthCheck
        displayName: 'Health Checks'
        steps:
          - script: |
              echo "Running health checks..."
              
              # Frontend health check
              FRONTEND_URL="https://nexus-$(environment).azurestaticapps.net"
              for i in {1..5}; do
                STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL")
                if [ "$STATUS" = "200" ]; then
                  echo "✅ Frontend is healthy"
                  break
                fi
                echo "Attempt $i: Frontend returned $STATUS, retrying..."
                sleep 10
              done
              
              # API health check
              API_URL="https://nexus-$(environment)-func.azurewebsites.net/api/health"
              for i in {1..5}; do
                STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL")
                if [ "$STATUS" = "200" ]; then
                  echo "✅ API is healthy"
                  break
                fi
                echo "Attempt $i: API returned $STATUS, retrying..."
                sleep 10
              done
            displayName: 'Run health checks'

  - stage: Notify
    displayName: 'Notify'
    dependsOn: Smoke_Tests
    condition: always()
    jobs:
      - job: SlackNotify
        displayName: 'Send Notification'
        steps:
          - script: |
              if [ "$(Agent.JobStatus)" = "Succeeded" ]; then
                STATUS="✅ Success"
                COLOR="good"
              else
                STATUS="❌ Failed"
                COLOR="danger"
              fi
              
              curl -X POST "$(SLACK_WEBHOOK_URL)" \
                -H "Content-Type: application/json" \
                -d "{
                  \"attachments\": [{
                    \"color\": \"$COLOR\",
                    \"title\": \"Nexus OS - Dev Deployment\",
                    \"text\": \"$STATUS\",
                    \"fields\": [
                      {\"title\": \"Environment\", \"value\": \"$(environment)\", \"short\": true},
                      {\"title\": \"Build\", \"value\": \"$(Build.BuildId)\", \"short\": true}
                    ]
                  }]
                }"
            displayName: 'Send Slack notification'
            condition: and(always(), ne(variables['SLACK_WEBHOOK_URL'], ''))
