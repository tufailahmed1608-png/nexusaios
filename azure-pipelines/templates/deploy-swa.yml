# azure-pipelines/templates/deploy-swa.yml
# Reusable template for deploying Static Web Apps

parameters:
  - name: environment
    type: string
  - name: azureSubscription
    type: string
  - name: resourceGroupName
    type: string
  - name: artifactName
    type: string
    default: 'webapp'

steps:
  - download: current
    artifact: ${{ parameters.artifactName }}
    displayName: 'Download build artifact'

  - script: |
      curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
    displayName: 'Install Azure CLI'

  - task: AzureCLI@2
    displayName: 'Discover SWA and Deploy'
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        set -e
        
        echo "üîç Discovering Static Web App in resource group: ${{ parameters.resourceGroupName }}"
        
        # Get SWA name dynamically
        SWA_NAME=$(az staticwebapp list \
          --resource-group "${{ parameters.resourceGroupName }}" \
          --query "[0].name" -o tsv)
        
        if [ -z "$SWA_NAME" ]; then
          echo "‚ùå Error: No Static Web App found in resource group ${{ parameters.resourceGroupName }}"
          exit 1
        fi
        
        echo "‚úÖ Found Static Web App: $SWA_NAME"
        
        # Get deployment token
        DEPLOYMENT_TOKEN=$(az staticwebapp secrets list \
          --name "$SWA_NAME" \
          --resource-group "${{ parameters.resourceGroupName }}" \
          --query "properties.apiKey" -o tsv)
        
        if [ -z "$DEPLOYMENT_TOKEN" ]; then
          echo "‚ùå Error: Failed to retrieve deployment token"
          exit 1
        fi
        
        echo "üîë Retrieved deployment token"
        
        # Install SWA CLI
        npm install -g @azure/static-web-apps-cli
        
        # Debug: List artifact contents
        echo "üì¶ Artifact contents:"
        ls -la $(Pipeline.Workspace)/${{ parameters.artifactName }}
        
        # Deploy to SWA
        echo "üöÄ Deploying to Static Web App..."
        swa deploy $(Pipeline.Workspace)/${{ parameters.artifactName }} \
          --deployment-token "$DEPLOYMENT_TOKEN" \
          --env "${{ parameters.environment }}" \
          --verbose
        
        # Output deployed URL
        SWA_URL=$(az staticwebapp show \
          --name "$SWA_NAME" \
          --resource-group "${{ parameters.resourceGroupName }}" \
          --query "defaultHostname" -o tsv)
        
        echo "‚úÖ Deployment complete!"
        echo "üåê Application URL: https://$SWA_URL"
        echo "##vso[task.setvariable variable=SWA_URL;isOutput=true]https://$SWA_URL"
    name: deployStep

  - script: |
      echo "üìã Deployment Summary"
      echo "====================="
      echo "Environment: ${{ parameters.environment }}"
      echo "Resource Group: ${{ parameters.resourceGroupName }}"
      echo "Deployed URL: $(deployStep.SWA_URL)"
    displayName: 'Deployment Summary'
